#pragma warning(disable: 4996)
#include <iostream>
#include <string>

#define _WINSOCK_DEPRECATED_NO_WARNINGS
#include <WinSock2.h>
#include <WS2tcpip.h>

#pragma comment(lib, "Ws2_32.lib")
#define BUF_SIZE 4096

using namespace std;

// Простая функция для HTTP запроса
bool makeRequest(const string& host, int port, const string& request) {
    SOCKET sock = socket(AF_INET, SOCK_STREAM, 0);
    if (sock == INVALID_SOCKET) {
        cout << "Socket error!\n";
        return false;
    }

    sockaddr_in addr;
    addr.sin_family = AF_INET;
    addr.sin_port = htons(port);

    // Разрешаем имя хоста
    hostent* h = gethostbyname(host.c_str());
    if (!h) {
        cout << "Cannot resolve host: " << host << "\n";
        closesocket(sock);
        return false;
    }
    
    addr.sin_addr.s_addr = *((unsigned long*)h->h_addr);

    // Устанавливаем таймаут на соединение (5 секунд)
    int timeout = 5000;
    setsockopt(sock, SOL_SOCKET, SO_RCVTIMEO, (char*)&timeout, sizeof(timeout));
    setsockopt(sock, SOL_SOCKET, SO_SNDTIMEO, (char*)&timeout, sizeof(timeout));

    cout << "Connecting to " << host << ":" << port << "...\n";
    
    if (connect(sock, (sockaddr*)&addr, sizeof(addr)) == SOCKET_ERROR) {
        cout << "Connection failed!\n";
        closesocket(sock);
        return false;
    }

    cout << "Sending request...\n";
    if (send(sock, request.c_str(), request.length(), 0) == SOCKET_ERROR) {
        cout << "Send failed!\n";
        closesocket(sock);
        return false;
    }

    cout << "\n=== Response from " << host << " ===\n";
    
    char buffer[BUF_SIZE];
    int bytesReceived;
    int totalBytes = 0;
    
    do {
        bytesReceived = recv(sock, buffer, BUF_SIZE - 1, 0);
        if (bytesReceived > 0) {
            buffer[bytesReceived] = '\0';
            cout << buffer;
            totalBytes += bytesReceived;
        }
        else if (bytesReceived == 0) {
            cout << "\nConnection closed by server.\n";
            break;
        }
        else {
            // SOCKET_ERROR - но это может быть таймаут, что нормально
            cout << "\nReceive completed or timeout reached.\n";
            break;
        }
    } while (bytesReceived > 0);

    cout << "\n=== End of response (" << totalBytes << " bytes) ===\n\n";
    
    closesocket(sock);
    return true;
}

int main() {
    cout << "\tHTTP Client v1.0\n";
    for (int i = 0; i < 30; i++) cout << "=";
    cout << "\n";
    
    // Инициализация Winsock
    WSADATA ws;
    if (WSAStartup(MAKEWORD(2, 2), &ws) != 0) {
        cout << "WSAStartup failed!\n";
        return 1;
    }

    while (true) {
        cout << "\nChoose connection type:\n";
        cout << "1. Connect to C++ HTTP Server (localhost:8000)\n";
        cout << "2. Connect to json.org\n";
        cout << "3. Connect to library.ru\n";
        cout << "0. Exit\n";
        cout << "Your choice: ";
        
        int choice;
        cin >> choice;
        
        if (choice == 0) {
            break;
        }
        
        string host;
        int port = 80;
        string request;
        
        switch (choice) {
            case 1:
                host = "localhost";
                port = 8000;
                request = "GET / HTTP/1.1\r\nHost: localhost\r\n\r\n";
                break;
            case 2:
                host = "json.org";
                request = "GET / HTTP/1.1\r\nHost: json.org\r\nConnection: close\r\n\r\n";
                break;
            case 3:
                host = "library.ru";
                request = "GET / HTTP/1.1\r\nHost: library.ru\r\nConnection: close\r\n\r\n";
                break;
            default:
                cout << "Invalid choice! Try again.\n";
                continue;
        }
        
        cout << "\n";
makeRequest(host, port, request);
        
        // Очистка буфера ввода после использования
        cin.clear();
        cin.ignore(10000, '\n');
    }
    
    WSACleanup();
    cout << "\nGoodbye!\n";
    
    // Пауза перед выходом (для Windows)
    system("pause");
    return 0;
}
#pragma warning(disable: 4996)
#include <iostream>
#include <sstream>
#include <string>

#define _WIN32_WINNT 0x501
#include <WinSock2.h>
#include <WS2tcpip.h>

#pragma comment(lib, "Ws2_32.lib")
#define BUF_SIZE 1024

using namespace std;

int main() {
    cout << "\tHTTP Server v1.0\n";
    for (int i = 0; i < 30; i++) cout << "=";
    cout << "\n";

    WSADATA ws;
    if (WSAStartup(MAKEWORD(2, 2), &ws)) {
        cout << "WSAStartup error: " << WSAGetLastError() << "\n";
        return -1;
    }

    SOCKET listener = socket(AF_INET, SOCK_STREAM, 0);
    if (listener == INVALID_SOCKET) {
        cout << "Socket error: " << WSAGetLastError() << "\n";
        WSACleanup();
        return -1;
    }

    sockaddr_in addr;
    addr.sin_family = AF_INET;
    addr.sin_port = htons(8000);
    addr.sin_addr.s_addr = inet_addr("127.0.0.1");

    if (bind(listener, (sockaddr*)&addr, sizeof(addr)) == SOCKET_ERROR) {
        cout << "Bind error: " << WSAGetLastError() << "\n";
        closesocket(listener);
        WSACleanup();
        return -1;
    }

    listen(listener, SOMAXCONN);
    cout << "Server started at http://localhost:8000\n";

    while (true) {
        sockaddr_in clientAddr;
        int clientSize = sizeof(clientAddr);
        SOCKET client = accept(listener, (sockaddr*)&clientAddr, &clientSize);
        
        char buffer[BUF_SIZE] = {};
        int len = recv(client, buffer, BUF_SIZE, 0);
        
        if (len > 0) {
            buffer[len] = '\0';
            
            stringstream html;
            html << "<html><head><title>HTTP Server</title></head>"
                << "<body><h1>Welcome to C++ HTTP Server</h1>"
                << "<p>Request received:</p>"
                << "<pre>" << buffer << "</pre>"
                << "</body></html>";
            
            string response = "HTTP/1.1 200 OK\r\n"
                            "Content-Type: text/html; charset=utf-8\r\n"
                            "Content-Length: " + to_string(html.str().length()) + 
                            "\r\n\r\n" + html.str();
            
            send(client, response.c_str(), response.length(), 0);
        }
        
        closesocket(client);
    }

    closesocket(listener);
    WSACleanup();
    return 0;
}
